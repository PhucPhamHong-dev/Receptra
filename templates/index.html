<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Chatbot B·ªánh vi·ªán</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Be Vietnam Pro', sans-serif; }
  </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen p-4">
  <div class="max-w-lg w-full bg-white shadow-lg rounded-lg overflow-hidden">
    <!-- Header -->
    <div class="p-6 bg-red-600 text-white">
      <h1 class="text-2xl font-semibold">Receptra xin ch√†o üëã</h1>
      <p>B·∫°n c·∫ßn h·ªó tr·ª£ g√¨ h√¥m nay?</p>
    </div>

    <!-- Prompt m·∫´u -->
    <div class="p-4 space-y-2">
      <div class="flex flex-wrap gap-2">
        <button class="prompt-card px-4 py-2 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200"
                data-prompt="üè• T√¥i mu·ªën ƒë·∫∑t l·ªãch kh√°m.">ƒê·∫∑t l·ªãch kh√°m</button>
        <button class="prompt-card px-4 py-2 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200"
                data-prompt="‚åö Gi·ªù l√†m vi·ªác c·ªßa b·ªánh vi·ªán l√†?">Gi·ªù l√†m vi·ªác</button>
        <button class="prompt-card px-4 py-2 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200"
                data-prompt="üîé T√¥i mu·ªën t√¨m khoa n·ªôi th·∫ßn kinh.">T√¨m khoa ph√≤ng</button>
      </div>
    </div>

    <!-- Khung chat -->
    <div id="chat-window" class="p-4 h-64 overflow-y-auto space-y-3 bg-white"></div>

    <!-- Typing indicator -->
    <div id="typing-indicator" class="px-4 py-2 text-gray-500 italic hidden">
      Bot ƒëang nh·∫≠p...
    </div>

    <!-- Input -->
    <div class="p-4 border-t">
      <div class="flex gap-2">
        <input id="user-input" type="text" placeholder="Nh·∫≠p c√¢u h·ªèi..."
               class="flex-1 border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-400">
        <button id="send-btn"
                class="px-5 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
          Send
        </button>
      </div>
    </div>
  </div>

  <script>
    const chatWindow = document.getElementById("chat-window");
    const inputEl    = document.getElementById("user-input");
    const sendBtn    = document.getElementById("send-btn");
    const typingEl   = document.getElementById("typing-indicator");
    const prompts    = document.querySelectorAll(".prompt-card");

    // 1. Click prompt => g√°n v√†o input
    prompts.forEach(btn =>
      btn.addEventListener("click", () => {
        inputEl.value = btn.dataset.prompt;
        inputEl.focus();
      })
    );

    // 2. G·ª≠i tin nh·∫Øn ng∆∞·ªùi d√πng
    sendBtn.addEventListener("click", async () => {
      const text = inputEl.value.trim();
      if (!text) return;

      // Hi·ªÉn th·ªã tin ng∆∞·ªùi d√πng
      const userDiv = document.createElement("div");
      userDiv.className = "text-right text-gray-800";
      userDiv.innerHTML = `<span class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-lg">${text}</span>`;
      chatWindow.appendChild(userDiv);

      inputEl.value = "";
      chatWindow.scrollTop = chatWindow.scrollHeight;

      // Hi·ªÉn th·ªã typing
      typingEl.classList.remove("hidden");

      // G·ªçi API Flask
      try {
        const res = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: text })
        });
        await res.json(); // Kh√¥ng c·∫ßn `reply`, v√¨ s·∫Ω l·∫•y sau qua polling
        typingEl.classList.add("hidden");
      } catch (err) {
        typingEl.classList.add("hidden");
        console.error("L·ªói khi g·ªçi /chat:", err);
      }
    });

    // Cho ph√©p Enter ƒë·ªÉ g·ª≠i
    inputEl.addEventListener("keyup", e => {
      if (e.key === "Enter") sendBtn.click();
    });

    // 3. Polling /latest-reply m·ªói 2 gi√¢y
    setInterval(async () => {
      try {
        const res = await fetch("/latest-reply");
        const data = await res.json();
        if (data.reply) {
          const botDiv = document.createElement("div");
          botDiv.className = "text-left text-gray-900";
          botDiv.innerHTML = `<span class="inline-block bg-gray-100 px-3 py-1 rounded-lg">${data.reply}</span>`;
          chatWindow.appendChild(botDiv);
          chatWindow.scrollTop = chatWindow.scrollHeight;
        }
      } catch (e) {
        console.error("L·ªói khi fetch ph·∫£n h·ªìi:", e);
      }
    }, 2000);
  </script>
</body>
</html>
